name: Build ayugram-desktop (Arch package)

on:
  # 手动触发
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest

    # 在官方 Ubuntu runner 里跑 Arch Linux 容器
    container:
      image: archlinux:base-devel

    # 用 bash，写脚本方便一点
    defaults:
      run:
        shell: bash

    steps:
      # 0. 初始化：装基础工具 + clang/lld + ccache + builder 用户
      - name: Setup Arch container
        run: |
          pacman -Syu --noconfirm git sudo clang lld ccache

          # 创建普通用户，避免用 root 跑 makepkg
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

          # 简单配置一下 ccache
          mkdir -p /home/builder/.cache/ccache
          chown -R builder:builder /home/builder

      # 1. 恢复 ccache（只针对“源文件已经编过”的情况加速）
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: /home/builder/.cache/ccache
          key: ccache-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('**/PKGBUILD') }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ github.ref_name }}-
            ccache-${{ runner.os }}-

      # 2. clone 或更新 AUR PKGBUILD 仓库
      - name: Clone or update ayugram-desktop AUR repo
        run: |
          sudo -u builder bash <<'EOF'
          set -e
          cd "$HOME"

          if [ -d ayugram-desktop/.git ]; then
            cd ayugram-desktop
            git pull --rebase
          else
            rm -rf ayugram-desktop
            git clone https://aur.archlinux.org/ayugram-desktop.git
          fi
          EOF

      # 3. 用 clang + lld + ccache + 单线程 编译
      - name: Build package with makepkg
        run: |
          sudo -u builder bash <<'EOF'
          set -e
          cd "$HOME/ayugram-desktop"

          # 使用 clang/clang++，避免 binutils as 的那个断言 bug
          export CC=clang
          export CXX=clang++
          export LDFLAGS="$LDFLAGS -fuse-ld=lld"

          # 开 ccache
          export CCACHE_DIR="$HOME/.cache/ccache"
          export PATH="/usr/lib/ccache/bin:$PATH"

          # 降低资源占用
          export MAKEFLAGS="-j1"
          export CFLAGS="-O2 -pipe -fno-lto"
          export CXXFLAGS="-O2 -pipe -fno-lto"

          # -s 自动装依赖，--noconfirm 不交互
          # 不加 -e 的话第一次会完整解压构建；你以后可以改成 -e 复用 src/
          makepkg -s --noconfirm
          EOF

      # 4. 上传生成的 pkg.tar.zst 包
      - name: Upload built packages
        uses: actions/upload-artifact@v4
        with:
          name: ayugram-packages
          path: /home/builder/ayugram-desktop/*.pkg.tar.zst
          # 比如保留 7 天（可按需调整）
          retention-days: 7
