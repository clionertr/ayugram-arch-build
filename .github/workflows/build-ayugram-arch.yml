name: Build ayugram-desktop (Arch package)

on:
  # 手动触发
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest

    # 在 Ubuntu runner 里跑 Arch Linux 容器
    container:
      image: archlinux:base-devel

    defaults:
      run:
        shell: bash

    steps:
      # 0. 初始化：安装工具 + 创建 builder 用户
      - name: Setup Arch container
        run: |
          pacman -Syu --noconfirm git sudo clang lld ccache

          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

          mkdir -p /home/builder/.cache/ccache
          chown -R builder:builder /home/builder

      # 1. 恢复 ccache（成功构建过一次之后才会真正生效）
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: /home/builder/.cache/ccache
          key: ccache-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('**/PKGBUILD') }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ github.ref_name }}-
            ccache-${{ runner.os }}-

      # 2. clone / 更新 AUR 仓库
      - name: Clone or update ayugram-desktop AUR repo
        run: |
          sudo -u builder bash <<'EOF'
          set -e
          cd "$HOME"

          if [ -d ayugram-desktop/.git ]; then
            cd ayugram-desktop
            git pull --rebase
          else
            rm -rf ayugram-desktop
            git clone https://aur.archlinux.org/ayugram-desktop.git
          fi
          EOF

      # 3. 用 clang + lld + ccache 编译，并“屏蔽” ABSL_ATTRIBUTE_LIFETIME_BOUND
      - name: Build package with makepkg
        run: |
          sudo -u builder bash <<'EOF'
          set -e
          cd "$HOME/ayugram-desktop"

          # 用 clang 避开 binutils as 的崩溃
          export CC=clang
          export CXX=clang++
          export LDFLAGS="$LDFLAGS -fuse-ld=lld"

          # 开 ccache
          export CCACHE_DIR="$HOME/.cache/ccache"
          export PATH="/usr/lib/ccache/bin:$PATH"

          # 降内存占用
          export MAKEFLAGS="-j1"

          # 关键：把 ABSL_ATTRIBUTE_LIFETIME_BOUND 宏定义成“空”
          export CFLAGS="-O2 -pipe -fno-lto -DABSL_ATTRIBUTE_LIFETIME_BOUND="
          export CXXFLAGS="-O2 -pipe -fno-lto -DABSL_ATTRIBUTE_LIFETIME_BOUND="

          # -s 自动装依赖，--noconfirm 避免交互
          makepkg -s --noconfirm
          EOF

      # 4. 上传生成的包
      - name: Upload built packages
        uses: actions/upload-artifact@v4
        with:
          name: ayugram-packages
          path: /home/builder/ayugram-desktop/*.pkg.tar.zst
          retention-days: 7
